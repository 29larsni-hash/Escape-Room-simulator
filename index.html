<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <title>Advanced VR Escape Room - With Hints</title>
</head>
<body>
    <a-scene vr-mode-ui="enabled: true" background="color: #001122">
        <!-- Room -->
        <a-box position="0 0 0" width="8" height="4" depth="8" 
               material="color: #8B4513; side: back"></a-box>
        <a-plane position="0 -2 0" width="8" height="8" rotation="-90 0 0" 
                 color="#654321"></a-plane>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="point" position="0 1.5 0" color="#FFF"></a-light>
        
        <!-- HINT BOARD - Central Information -->
        <a-entity id="hint-board" position="0 1 -3.8">
            <a-box width="3" height="1.5" depth="0.05" color="#2C3E50"></a-box>
            <a-text position="0 0.6 0.03" value="ESCAPE ROOM GUIDE" align="center" color="#FFD700" 
                    font="kelsonsans" width="8"></a-text>
            
            <a-text id="current-hint" position="0 0.2 0.03" 
                    value="Watch the pattern demonstration, then repeat it!" 
                    align="center" color="#FFF" width="6"></a-text>
            
            <a-text position="0 -0.2 0.03" value="Click me for hints!" align="center" color="#00FF00" 
                    class="interactive" id="hint-button" width="4"></a-text>
            
            <a-text id="progress-hint" position="0 -0.5 0.03" 
                    value="Step 1/5: Solve Pattern Memory" align="center" color="#87CEEB" width="5"></a-text>
        </a-entity>
        
        <!-- PUZZLE 1: Pattern Memory Panel -->
        <a-entity id="pattern-panel" position="-3.5 0.5 -3.5">
            <a-box width="1.5" height="1" depth="0.1" color="#333"></a-box>
            <a-text position="0 0.7 0.1" value="Pattern Memory" align="center" color="#FFF"></a-text>
            <a-text position="0 -0.6 0.1" value="Watch → Remember → Repeat" align="center" color="#FFD700" width="4"></a-text>
            
            <!-- Pattern buttons with numbers -->
            <a-cylinder id="pattern-btn-1" position="-0.3 0.2 0.1" radius="0.1" height="0.05" 
                       color="#FF0000" class="interactive pattern-btn" data-pattern="1">
                <a-text position="0 0 0.03" value="1" align="center" color="#FFF"></a-text>
            </a-cylinder>
            <a-cylinder id="pattern-btn-2" position="0.3 0.2 0.1" radius="0.1" height="0.05" 
                       color="#FF0000" class="interactive pattern-btn" data-pattern="2">
                <a-text position="0 0 0.03" value="2" align="center" color="#FFF"></a-text>
            </a-cylinder>
            <a-cylinder id="pattern-btn-3" position="-0.3 -0.2 0.1" radius="0.1" height="0.05" 
                       color="#FF0000" class="interactive pattern-btn" data-pattern="3">
                <a-text position="0 0 0.03" value="3" align="center" color="#FFF"></a-text>
            </a-cylinder>
            <a-cylinder id="pattern-btn-4" position="0.3 -0.2 0.1" radius="0.1" height="0.05" 
                       color="#FF0000" class="interactive pattern-btn" data-pattern="4">
                <a-text position="0 0 0.03" value="4" align="center" color="#FFF"></a-text>
            </a-cylinder>
        </a-entity>
        
        <!-- Silver Key (hidden initially) -->
        <a-torus id="silver-key" position="-3.5 0.5 -2.8" radius="0.15" radius-tubular="0.04" 
                color="#C0C0C0" class="interactive" visible="false"
                animation="property: rotation; to: 0 360 0; dur: 2000; repeat: indefinite">
        </a-torus>
        
        <!-- PUZZLE 2: Combination Safe -->
        <a-entity id="safe" position="3.5 0 -3.5">
            <a-box width="1.2" height="1.5" depth="0.8" color="#2F4F4F"></a-box>
            <a-text position="0 1 0.5" value="SAFE" align="center" color="#FFF"></a-text>
            <a-text position="0 -1 0.5" value="Need Silver Key First!" align="center" color="#FF6B6B" width="4"></a-text>
            
            <!-- Hint plaque -->
            <a-box position="0 0.5 0.5" width="1" height="0.3" depth="0.02" color="#FFD700"></a-box>
            <a-text position="0 0.5 0.52" value="Lucky Numbers: 7-3-9" align="center" color="#000" width="6"></a-text>
            
            <!-- Combination dials with current numbers -->
            <a-cylinder id="dial-1" position="-0.3 0.2 0.45" radius="0.15" height="0.05" 
                       color="#FFD700" class="interactive dial" data-value="0" data-target="7">
                <a-text position="0 0 0.03" value="0" align="center" color="#000"></a-text>
            </a-cylinder>
            <a-cylinder id="dial-2" position="0 0.2 0.45" radius="0.15" height="0.05" 
                       color="#FFD700" class="interactive dial" data-value="0" data-target="3">
                <a-text position="0 0 0.03" value="0" align="center" color="#000"></a-text>
            </a-cylinder>
            <a-cylinder id="dial-3" position="0.3 0.2 0.45" radius="0.15" height="0.05" 
                       color="#FFD700" class="interactive dial" data-value="0" data-target="9">
                <a-text position="0 0 0.03" value="0" align="center" color="#000"></a-text>
            </a-cylinder>
            
            <!-- Keyhole -->
            <a-cylinder id="keyhole" position="0 -0.3 0.45" radius="0.05" height="0.05" 
                       color="#000" class="interactive">
                <a-text position="0 -0.15 0" value="Silver Keyhole" align="center" color="#C0C0C0" width="3"></a-text>
            </a-cylinder>
        </a-entity>
        
        <!-- PUZZLE 3: Mechanical Contraption -->
        <a-entity id="contraption" position="0 0.5 3.2" rotation="0 180 0">
            <a-box width="2" height="1" depth="0.3" color="#8B4513"></a-box>
            <a-text position="0 0.7 0.2" value="Mechanical Lock" align="center" color="blue"></a-text>
            <a-text position="0 -0.7 0.2" value="Need Both Tools First!" align="center" color="#FF6B6B" width="4"></a-text>
            
            <!-- Instruction plaque -->
            <a-box position="0 0.4 0.2" width="1.8" height="0.2" depth="0.02" color="#87CEEB"></a-box>
            <a-text position="0 0.4 0.22" value="Align all gears pointing DOWN" align="center" color="#000" width="6"></a-text>
            
            <!-- Gears with directional arrows -->
            <a-torus id="gear-1" position="-0.5 0 0.2" radius="0.2" radius-tubular="0.03" 
                    color="#B8860B" class="interactive gear" data-rotation="0">
                <a-text position="0 0 0.03" value="↑" align="center" color="#000" width="8"></a-text>
            </a-torus>
            <a-torus id="gear-2" position="0 0 0.2" radius="0.2" radius-tubular="0.03" 
                    color="#B8860B" class="interactive gear" data-rotation="0">
                <a-text position="0 0 0.03" value="↑" align="center" color="#000" width="8"></a-text>
            </a-torus>
            <a-torus id="gear-3" position="0.5 0 0.2" radius="0.2" radius-tubular="0.03" 
                    color="#B8860B" class="interactive gear" data-rotation="0">
                <a-text position="0 0 0.03" value="↑" align="center" color="#000" width="8"></a-text>
            </a-torus>
            
            <!-- Tool slots with labels -->
            <a-box id="wrench-slot" position="-0.7 -0.3 0.2" width="0.1" height="0.2" depth="0.05" 
                   color="#FF6B6B" class="interactive">
                <a-text position="0 -0.2 0" value="Wrench" align="center" color="#FFF" width="4"></a-text>
            </a-box>
            <a-box id="screwdriver-slot" position="0.7 -0.3 0.2" width="0.1" height="0.2" depth="0.05" 
                   color="#4ECDC4" class="interactive">
                <a-text position="0 -0.2 0" value="Screwdriver" align="center" color="#FFF" width="3"></a-text>
            </a-box>
        </a-entity>
        
        <!-- PUZZLE 4: Color Sequence Lock -->
      <a-entity id="sequence-lock" position="-3.2 0.5 3.2" rotation="0 180 0">
            <a-box width="1.5" height="1.2" depth="0.1" color="#2C3E50"></a-box>
            <a-text position="0 0.8 0.1" value="Sequence Lock" align="center" color="#FFF"></a-text>
            <a-text position="0 -0.8 0.1" value="Need Golden Key First!" align="center" color="#FF6B6B" width="4"></a-text>
            
            <!-- Color code hint -->
            <a-box position="0 0.5 0.1" width="1.4" height="0.15" depth="0.02" color="#000"></a-box>
            <a-text position="0.2 0.5 0.12" value="Code: B-G-Y-B-G-R" align="center" color="#FFF" width="6"></a-text>
            
            <!-- Color sequence buttons with position numbers -->
            <a-sphere id="seq-btn-1" position="-0.4 0.2 0.1" radius="0.08" 
                     color="#FF0000" class="interactive seq-btn" data-seq="1" data-state="red">
                <a-text position="0 0 0.1" value="1" align="center" color="#FFF" width="8"></a-text>
            </a-sphere>
            <a-sphere id="seq-btn-2" position="-0.1 0.2 0.1" radius="0.08" 
                     color="#FF0000" class="interactive seq-btn" data-seq="2" data-state="red">
                <a-text position="0 0 0.1" value="2" align="center" color="#FFF" width="8"></a-text>
            </a-sphere>
            <a-sphere id="seq-btn-3" position="0.2 0.2 0.1" radius="0.08" 
                     color="#FF0000" class="interactive seq-btn" data-seq="3" data-state="red">
                <a-text position="0 0 0.1" value="3" align="center" color="#FFF" width="8"></a-text>
            </a-sphere>
            <a-sphere id="seq-btn-4" position="-0.4 -0.1 0.1" radius="0.08" 
                     color="#FF0000" class="interactive seq-btn" data-seq="4" data-state="red">
                <a-text position="0 0 0.1" value="4" align="center" color="#FFF" width="8"></a-text>
            </a-sphere>
            <a-sphere id="seq-btn-5" position="-0.1 -0.1 0.1" radius="0.08" 
                     color="#FF0000" class="interactive seq-btn" data-seq="5" data-state="red">
                <a-text position="0 0 0.1" value="5" align="center" color="#FFF" width="8"></a-text>
            </a-sphere>
            <a-sphere id="seq-btn-6" position="0.2 -0.1 0.1" radius="0.08" 
                     color="#FF0000" class="interactive seq-btn" data-seq="6" data-state="red">
                <a-text position="0 0 0.1" value="6" align="center" color="#FFF" width="8"></a-text>
            </a-sphere>
                     
            <!-- Golden keyhole -->
            <a-cylinder id="golden-keyhole" position="0 -0.4 0.1" radius="0.06" height="0.05" 
                       color="#FFD700" class="interactive">
                <a-text position="0 -0.12 0" value="Golden Keyhole" align="center" color="#FFD700" width="3"></a-text>
            </a-cylinder>
        </a-entity>
        
        <!-- Tools with labels (hidden initially) -->
        <a-box id="wrench" position="3.5 -0.5 -2.5" width="0.05" height="0.3" depth="0.05" 
               color="#FF6B6B" class="interactive tool" visible="false">
            <a-text position="0 0.2 0" value="Wrench" align="center" color="green" width="4"></a-text>
        </a-box>
        <a-box id="screwdriver" position="3.8 -0.5 -3" width="0.03" height="0.25" depth="0.03" 
               color="#4ECDC4" class="interactive tool" visible="false">
            <a-text position="0 0.15 0" value="Screwdriver" align="center" color="green" width="3"></a-text>
        </a-box>
          <!-- Keys with labels -->
        <a-torus id="golden-key" position="0 0.2 3.8" radius="0.18" radius-tubular="0.05" 
                color="#FFD700" class="interactive" visible="false"
                animation="property: rotation; to: 0 360 0; dur: 2500; repeat: indefinite">
            <a-text position="0 0.3 0" value="Golden Key" align="center" color="#FFD700" width="4"></a-text>
        </a-torus>
        
        <!-- Master Key (final reward) -->
        <a-torus id="master-key" position="-3.5 0.2 3.8" radius="0.2" radius-tubular="0.06" 
                color="#FF1493" class="interactive" visible="false"
                animation="property: rotation; to: 0 360 0; dur: 3000; repeat: indefinite">
            <a-text position="0 0.35 0" value="Master Key" align="center" color="#FF1493" width="4"></a-text>
        </a-torus>
        
        <!-- Exit Door with clear instructions -->
        <a-box id="exit-door" position="3.8 0 0" width="0.4" height="2.5" depth="2" 
               color="#654321" class="interactive">
        </a-box>
        <a-text id="door-status" position="3.5 1.8 0" value="LOCKED - Need Master Key" align="center" color="#FF0000"></a-text>
        <a-text position="3.5 1.4 0" value="Complete all 4 puzzles!" align="center" color="#FFD700" width="4"></a-text>
        
        <!-- VR Camera Setup -->
        <a-entity id="cameraRig" position="0 0 0">
            <a-camera position="0 1.6 1" look-controls wasd-controls>
                <a-cursor color="#FFF" raycaster="objects: .interactive"></a-cursor>
            </a-camera>
            
            <a-entity id="leftHand" 
                      hand-controls="hand: left"
                      raycaster="objects: .interactive"
                      line="start: 0, 0, 0; end: 0 0 -3; color: blue; opacity: 0.5">
            </a-entity>
            
            <a-entity id="rightHand" 
                      hand-controls="hand: right"
                      raycaster="objects: .interactive"
                      line="start: 0, 0, 0; end: 0 0 -3; color: red; opacity: 0.5">
            </a-entity>
        </a-entity>
        
        <!-- Status Display -->
        <a-text id="status" position="0 3 -3.8" value="Follow the hints to escape!" 
                align="center" color="#FFF"></a-text>
    </a-scene>

    <script>
        const gameState = {
            patternSolved: false,
            hasSilverKey: false,
            safeSolved: false,
            hasTools: false,
            contraptionSolved: false,
            hasGoldenKey: false,
            sequenceSolved: false,
            hasMasterKey: false,
            escaped: false
        };

        // Puzzle solutions with hints
        const correctPattern = [1, 3, 2, 4];
        const correctSequence = ['blue', 'green', 'yellow', 'blue', 'green', 'red'];
        const sequenceColors = ['red', 'blue', 'green', 'yellow'];
        
        let patternInput = [];
        let sequenceInput = [];
        let toolsEquipped = { wrench: false, screwdriver: false };
        let hintLevel = 0;

        // Comprehensive hints system
        const hints = {
            pattern: [
                "Watch the pattern demonstration, then repeat it!",
                "The buttons will light up in a sequence - memorize it!",
                "Pattern hint: Press 1, then 3, then 2, then 4",
                "Exact solution: Button 1 → Button 3 → Button 2 → Button 4"
            ],
            safe: [
                "Use your Silver Key on the keyhole, then set the combination!",
                "The lucky numbers are written on the golden plaque: 7-3-9",
                "Click each dial to change its number, then use the key!",
                "Set LEFT dial to 7, MIDDLE to 3, RIGHT to 9, then insert key!"
            ],
            contraption: [
                "Collect both tools from the safe, then equip them in the slots!",
                "Click the tool slots to equip your wrench and screwdriver!",
                "All gears need to point DOWN (↓) to unlock the mechanism!",
                "Click each gear 3 times to make all arrows point downward!"
            ],
            sequence: [
                "Use your Golden Key, then set the color sequence!",
                "The code is shown: B-G-Y-B-G-R (Blue-Green-Yellow-Blue-Green-Red)",
                "What letter does each color start with?",
                "Button 1: Blue, Button 2: Green, Button 3: Yellow, Button 4: Blue, Button 5: Green, Button 6: Red"
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            setupInteractions();
            showPatternDemo();
            updateHintBoard();
        });

        function setupInteractions() {
            const interactives = document.querySelectorAll('.interactive');
            
            interactives.forEach(element => {
                element.addEventListener('click', handleInteraction);
                element.addEventListener('triggerdown', handleInteraction);
                
                element.addEventListener('mouseenter', function() {
                    element.setAttribute('scale', '1.1 1.1 1.1');
                });
                
                element.addEventListener('mouseleave', function() {
                    element.setAttribute('scale', '1 1 1');
                });
            });
        }

        function handleInteraction(event) {
            const element = event.target;
            const id = element.id;
            
            // Hint button
            if (id === 'hint-button') {
                showNextHint();
                return;
            }
            
            // Pattern Memory Puzzle
            if (element.classList.contains('pattern-btn') && !gameState.patternSolved) {
                handlePatternButton(element);
            }
            
            // Safe interactions
            else if (element.classList.contains('dial') && gameState.hasSilverKey) {
                rotateDial(element);
            }
            else if (id === 'keyhole' && gameState.hasSilverKey) {
                checkSafeCombination();
            }
            
            // Tool collection
            else if (element.classList.contains('tool') && gameState.safeSolved) {
                collectTool(element);
            }
            
            // Contraption interactions
            else if (element.classList.contains('gear') && toolsEquipped.wrench && toolsEquipped.screwdriver) {
                rotateGear(element);
            }
            else if (id === 'wrench-slot' && gameState.hasTools) {
                equipTool('wrench');
            }
            else if (id === 'screwdriver-slot' && gameState.hasTools) {
                equipTool('screwdriver');
            }
            
            // Sequence lock
            else if (element.classList.contains('seq-btn') && gameState.hasGoldenKey) {
                cycleSequenceButton(element);
            }
            else if (id === 'golden-keyhole' && gameState.hasGoldenKey) {
                checkSequence();
            }
            
            // Key collection
            else if (id === 'silver-key') {
                collectKey('silver');
            }
            else if (id === 'golden-key') {
                collectKey('golden');
            }
            else if (id === 'master-key') {
                collectKey('master');
            }
            
            // Exit door
            else if (id === 'exit-door') {
                checkExit();
            }
            
            updateStatus();
            updateHintBoard();
        }

        function showNextHint() {
            hintLevel = (hintLevel + 1) % 4;
            updateHintBoard();
        }

        function updateHintBoard() {
            const currentHint = document.getElementById('current-hint');
            const progressHint = document.getElementById('progress-hint');
            
            let currentPuzzle = 'pattern';
            let step = '1/5: Solve Pattern Memory';
            
            if (!gameState.patternSolved) {
                currentPuzzle = 'pattern';
                step = '1/5: Solve Pattern Memory';
            } else if (!gameState.hasSilverKey) {
                currentHint.setAttribute('value', 'Collect the Silver Key that appeared!');
                step = '2/5: Collect Silver Key';
                return;
            } else if (!gameState.safeSolved) {
                currentPuzzle = 'safe';
                step = '3/5: Open the Safe';
            } else if (!gameState.contraptionSolved) {
                currentPuzzle = 'contraption';
                step = '4/5: Solve Mechanical Lock';
            } else if (!gameState.sequenceSolved) {
                currentPuzzle = 'sequence';
                step = '5/5: Solve Color Sequence';
            } else {
                currentHint.setAttribute('value', 'Collect the Master Key and escape!');
                step = 'Final: Escape with Master Key!';
                return;
            }
            
            currentHint.setAttribute('value', hints[currentPuzzle][hintLevel]);
            progressHint.setAttribute('value', step);
        }

        // PUZZLE 1: Pattern Memory (enhanced with better feedback)
        function showPatternDemo() {
            const buttons = document.querySelectorAll('.pattern-btn');
            let step = 0;
            
            updateStatus('Watch carefully! Pattern starting in 3 seconds...');
            
            setTimeout(() => {
                const demo = setInterval(() => {
                    if (step < correctPattern.length) {
                        const btn = document.getElementById(`pattern-btn-${correctPattern[step]}`);
                        btn.setAttribute('color', '#00FF00');
                        
                        setTimeout(() => {
                            btn.setAttribute('color', '#FF0000');
                        }, 600);
                        step++;
                    } else {
                        clearInterval(demo);
                        updateStatus('Now repeat the pattern you just saw!');
                    }
                }, 1000);
            }, 3000);
        }

        function handlePatternButton(button) {
            const patternNum = parseInt(button.getAttribute('data-pattern'));
            patternInput.push(patternNum);
            
            // Visual feedback
            button.setAttribute('color', '#00FF00');
            setTimeout(() => {
                button.setAttribute('color', '#FF0000');
            }, 200);
            
            // Check pattern progress
            if (patternInput.length <= correctPattern.length) {
                let correct = true;
                for (let i = 0; i < patternInput.length; i++) {
                    if (patternInput[i] !== correctPattern[i]) {
                        correct = false;
                        break;
                    }
                }
                
                if (!correct) {
                    patternInput = [];
                    updateStatus('Wrong! Watch the pattern again...');
                    setTimeout(() => showPatternDemo(), 2000);
                } else if (patternInput.length === correctPattern.length) {
                    gameState.patternSolved = true;
                    document.getElementById('silver-key').setAttribute('visible', 'true');
                    updateStatus('Perfect! Silver key revealed - collect it!');
                } else {
                    updateStatus(`Good! Keep going... (${patternInput.length}/${correctPattern.length})`);
                }
            }
        }

        // PUZZLE 2: Safe (enhanced with visual feedback)
        function rotateDial(dial) {
            let value = parseInt(dial.getAttribute('data-value'));
            value = (value + 1) % 10;
            dial.setAttribute('data-value', value.toString());
            dial.setAttribute('rotation', `0 0 ${value * 36}`);
            
            // Update number display
            const numberDisplay = dial.querySelector('a-text');
            numberDisplay.setAttribute('value', value.toString());
            
            // Color feedback for correct numbers
            const target = parseInt(dial.getAttribute('data-target'));
            if (value === target) {
                dial.setAttribute('color', '#00FF00');
            } else {
                dial.setAttribute('color', '#FFD700');
            }
        }

        function checkSafeCombination() {
            const dial1 = parseInt(document.getElementById('dial-1').getAttribute('data-value'));
            const dial2 = parseInt(document.getElementById('dial-2').getAttribute('data-value'));
            const dial3 = parseInt(document.getElementById('dial-3').getAttribute('data-value'));
            
            if (dial1 === 7 && dial2 === 3 && dial3 === 9) {
                gameState.safeSolved = true;
                gameState.hasTools = true;
                
                document.getElementById('wrench').setAttribute('visible', 'true');
                document.getElementById('screwdriver').setAttribute('visible', 'true');
                
                const safe = document.getElementById('safe');
                safe.setAttribute('animation', 'property: rotation; to: 0 45 0; dur: 1000');
                
                updateStatus('Safe opened! Collect both tools!');
            } else {
                updateStatus(`Combination ${dial1}-${dial2}-${dial3} is wrong! Try 7-3-9!`);
            }
        }

        // Tool System (enhanced)
        function collectTool(tool) {
            tool.setAttribute('animation', 'property: scale; to: 0 0 0; dur: 500');
            setTimeout(() => tool.remove(), 500);
            updateStatus(`${tool.id.charAt(0).toUpperCase() + tool.id.slice(1)} collected! Equip it at the contraption!`);
        }

        function equipTool(toolType) {
            toolsEquipped[toolType] = true;
            const slot = document.getElementById(`${toolType}-slot`);
            slot.setAttribute('color', '#00FF00');
            
            if (toolsEquipped.wrench && toolsEquipped.screwdriver) {
                updateStatus('Both tools equipped! Now click the gears to align them!');
            } else {
                updateStatus(`${toolType} equipped! Need both tools to operate gears.`);
            }
        }

        // PUZZLE 3: Mechanical Contraption (enhanced with arrow indicators)
        function rotateGear(gear) {
            let rotation = parseInt(gear.getAttribute('data-rotation'));
            rotation = (rotation + 60) % 360;
            gear.setAttribute('data-rotation', rotation.toString());
            gear.setAttribute('rotation', `0 0 ${rotation}`);
            
            // Update arrow direction
            const arrow = gear.querySelector('a-text');
            const arrows = ['↑', '↗', '→', '↘', '↓', '↙'];
            const arrowIndex = rotation / 60;
            arrow.setAttribute('value', arrows[arrowIndex]);
            
            // Color feedback
            if (rotation === 240) { // Down position
                gear.setAttribute('color', '#00FF00');
            } else {
                gear.setAttribute('color', '#B8860B');
            }
            
            checkGearAlignment();
        }

        function checkGearAlignment() {
            const gear1Rot = parseInt(document.getElementById('gear-1').getAttribute('data-rotation'));
            const gear2Rot = parseInt(document.getElementById('gear-2').getAttribute('data-rotation'));
            const gear3Rot = parseInt(document.getElementById('gear-3').getAttribute('data-rotation'));
             if (gear1Rot === 240 && gear2Rot === 240 && gear3Rot === 240) {
                gameState.contraptionSolved = true;
                gameState.hasGoldenKey = true;
                
                document.getElementById('golden-key').setAttribute('visible', 'true');
                
                // Success animation for all gears
                document.querySelectorAll('.gear').forEach(gear => {
                    gear.setAttribute('animation', 'property: scale; to: 1.2 1.2 1.2; dur: 500; repeat: 2; direction: alternate');
                });
                
                updateStatus('All gears aligned! Golden key revealed - collect it!');
            } else {
                const aligned = [gear1Rot, gear2Rot, gear3Rot].filter(rot => rot === 240).length;
                updateStatus(`Gears aligned: ${aligned}/3. Keep clicking to point them all DOWN!`);
            }
        }

        // PUZZLE 4: Color Sequence Lock (enhanced with better feedback)
        function cycleSequenceButton(button) {
            const currentState = button.getAttribute('data-state');
            const currentIndex = sequenceColors.indexOf(currentState);
            const nextIndex = (currentIndex + 1) % sequenceColors.length;
            const nextColor = sequenceColors[nextIndex];
            
            button.setAttribute('data-state', nextColor);
            button.setAttribute('color', getColorHex(nextColor));
            
            // Show current sequence progress
            updateSequenceDisplay();
        }

        function updateSequenceDisplay() {
            let currentSeq = [];
            for (let i = 1; i <= 6; i++) {
                const button = document.getElementById(`seq-btn-${i}`);
                const color = button.getAttribute('data-state');
                currentSeq.push(color.charAt(0).toUpperCase()); // First letter
            }
            updateStatus(`Current: ${currentSeq.join('-')} | Target: B-G-Y-B-G-R`);
        }

        function getColorHex(colorName) {
            const colorMap = {
                'red': '#FF0000',
                'blue': '#0000FF',
                'green': '#00FF00',
                'yellow': '#FFFF00'
            };
            return colorMap[colorName];
        }

        function checkSequence() {
            sequenceInput = [];
            for (let i = 1; i <= 6; i++) {
                const button = document.getElementById(`seq-btn-${i}`);
                sequenceInput.push(button.getAttribute('data-state'));
            }
            
            let correct = true;
            let correctCount = 0;
            
            for (let i = 0; i < correctSequence.length; i++) {
                if (sequenceInput[i] === correctSequence[i]) {
                    correctCount++;
                } else {
                    correct = false;
                }
            }
            
            if (correct) {
                gameState.sequenceSolved = true;
                gameState.hasMasterKey = true;
                
                document.getElementById('master-key').setAttribute('visible', 'true');
                
                // Success animation for all buttons
                document.querySelectorAll('.seq-btn').forEach(btn => {
                    btn.setAttribute('animation', 'property: scale; to: 1.3 1.3 1.3; dur: 300; repeat: 3; direction: alternate');
                });
                
                updateStatus('Perfect sequence! Master key revealed - collect it and escape!');
            } else {
                updateStatus(`${correctCount}/6 colors correct! Keep adjusting the sequence.`);
            }
        }

        // Key Collection System (enhanced with better feedback)
        function collectKey(keyType) {
            const keyElement = document.getElementById(`${keyType}-key`);
            keyElement.setAttribute('animation', 'property: position; to: 0 2.5 0; dur: 1000');
            
            setTimeout(() => {
                keyElement.setAttribute('animation', 'property: scale; to: 0 0 0; dur: 500');
                setTimeout(() => keyElement.remove(), 500);
            }, 1000);
            
            if (keyType === 'silver') {
                gameState.hasSilverKey = true;
                updateStatus('Silver key collected! Go to the safe and use it!');
            } else if (keyType === 'golden') {
                gameState.hasGoldenKey = true;
                updateStatus('Golden key collected! Go to the sequence lock!');
            } else if (keyType === 'master') {
                gameState.hasMasterKey = true;
                updateStatus('Master key collected! Click the exit door to escape!');
            }
        }

        // Exit System (enhanced)
        function checkExit() {
            if (gameState.hasMasterKey) {
                gameState.escaped = true;
                
                const door = document.getElementById('exit-door');
                const doorStatus = document.getElementById('door-status');
                
                door.setAttribute('animation', 'property: rotation; to: 0 90 0; dur: 2000');
                door.setAttribute('color', '#00FF00');
                doorStatus.setAttribute('value', '🎉 ESCAPED! 🎉');
                doorStatus.setAttribute('color', '#00FF00');
                
                updateStatus('🎉 CONGRATULATIONS! You solved all puzzles and escaped! 🎉');
                
                // Victory celebration
                setTimeout(() => {
                    document.querySelectorAll('.interactive').forEach(element => {
                        if (element.parentNode) { // Check if element still exists
                            element.setAttribute('animation', 'property: rotation; to: 0 720 0; dur: 3000');
                        }
                    });
                }, 500);
                
                // Update hint board for victory
                document.getElementById('current-hint').setAttribute('value', 'YOU DID IT! Amazing puzzle solving!');
                document.getElementById('progress-hint').setAttribute('value', '✅ ALL PUZZLES COMPLETED! ✅');
                
            } else {
                // Detailed feedback on what's still needed
                let needed = [];
                let nextStep = '';
                
                if (!gameState.patternSolved) {
                    needed.push('Pattern Memory Puzzle');
                    nextStep = 'Start with the pattern memory puzzle!';
                } else if (!gameState.hasSilverKey) {
                    needed.push('Collect Silver Key');
                    nextStep = 'Collect the silver key that appeared!';
                } else if (!gameState.safeSolved) {
                    needed.push('Open Safe (7-3-9)');
                    nextStep = 'Use silver key on safe with combination 7-3-9!';
                } else if (!gameState.hasTools) {
                    needed.push('Collect Tools');
                    nextStep = 'Collect both tools from the opened safe!';
                } else if (!gameState.contraptionSolved) {
                    needed.push('Align Gears (all pointing down)');
                    nextStep = 'Equip tools and align all gears pointing down!';
                } else if (!gameState.hasGoldenKey) {
                    needed.push('Collect Golden Key');
                    nextStep = 'Collect the golden key that appeared!';
                } else if (!gameState.sequenceSolved) {
                    needed.push('Color Sequence (B-G-Y-B-G-R)');
                    nextStep = 'Set color sequence: Blue-Green-Yellow-Blue-Green-Red!';
                } else if (!gameState.hasMasterKey) {
                    needed.push('Collect Master Key');
                    nextStep = 'Collect the master key that appeared!';
                }
                
                updateStatus(`Still needed: ${needed.join(', ')}. ${nextStep}`);
            }
        }

        function updateStatus(message) {
            const status = document.getElementById('status');
            if (message) {
                status.setAttribute('value', message);
            } else {
                const completed = [
                    gameState.patternSolved,
                    gameState.hasSilverKey,
                    gameState.safeSolved,
                    gameState.contraptionSolved,
                    gameState.sequenceSolved
                ].filter(Boolean).length;
                status.setAttribute('value', `Progress: ${completed}/5 major steps completed`);
            }
        }
    </script>
</body>
</html>
